name: Daily Viral Shorts

on:
  schedule:
    - cron: '0 */8 * * *'  # Runs every 8 hours
  workflow_dispatch:      # Allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies (FFmpeg)
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install google-api-python-client google-auth-oauthlib google-auth-httplib2 moviepy edge-tts yt-dlp

    - name: Restore Credentials from Secrets
      env:
        CLIENT_SECRETS: ${{ secrets.CLIENT_SECRETS_JSON }}
        YOUTUBE_TOKEN: ${{ secrets.YOUTUBE_TOKEN_BASE64 }}
      run: |
        # Write credentials to the factory folder
        echo "$CLIENT_SECRETS" > YouTube_Shorts_Factory/client_secrets.json
        python -c "import base64, os; open('YouTube_Shorts_Factory/youtube_token.pickle', 'wb').write(base64.b64decode(os.environ['YOUTUBE_TOKEN']))"

    - name: Run YouTube Shorts Factory
      env:
        PYTHONUNBUFFERED: 1
      run: |
        cd YouTube_Shorts_Factory
        python workflow.py --auto

    - name: Commit and Push Download History
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git add YouTube_Shorts_Factory/downloaded_videos.txt || true
        git commit -m "Update download history" || true
        git push


